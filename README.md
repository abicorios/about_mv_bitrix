# about_mv_bitrix
Информация о переносе Битрикс. Предполагается что нужно перенести тестовый сайт с сервера на локальную виртуальную машину для разработки. Возможна такая сложность, что если база очень большая то стандартный бэкап Битрикс зависнет. Тогда нужно другим способом переносить.

# Дамп базы данных
Возможно в базе есть какие-то слишком большие таблицы, информация из которых не понадобится при разработке. Размер таблиц можно проверить запросом:
```
SELECT
table_schema as `Database`,
table_name AS `Table`,
round(((data_length + index_length) / 1024 / 1024), 2) `Size in MB`
FROM information_schema.TABLES
ORDER BY (data_length + index_length) DESC;
```
Запрос можно выполнить например в административно разделе сайта, в `Настройки->Инструменты->SQL запрос`.

Потом нужно залогиниться на сервер, на котором размещён сайт. Выполнить дамп структуры базы:
```
mysqldump -u bitrix0 -p --single-transaction --no-data --routines sitemanager > dump.sql
```
При этом будет запрошен пароль. Пароль можно узнать в файле `bitrix/.settings.php`, ближе к завершению файла.

Если ранее выяснилось, например, что таблица `b_mail_message` занимает слишком много места, и её содержимое не важно для разработки, то далее можно выполняя дамп содержимого таблиц исключить `b_mail_message`:
```
mysqldump -u bitrix0 -p sitemanager --no-create-info --skip-triggers --ignore-table=sitemanager.b_mail_message >> dump.sql
```

Если нужно исключить вторую таблицу, например `b_search_content_stem`, то нужно повторить ключ `--ignore-table` ещё раз, то есть получится `mysqldump -u bitrix0 -p sitemanager --no-create-info --skip-triggers --ignore-table=sitemanager.b_mail_message --ignore-table=sitemanager.b_search_content_stem >> medirus.dump.sql`.
Дамп может занять продолжительное время, зависит от размера базы. Не рекомендуется использовать ключи для вывода информации в терминал, это только замедлит процесс. Лучше заранее посмотреть размер базы запросом:
```
SELECT
round(SUM((data_length + index_length) / 1024 / 1024), 2) `Size in MB`
FROM information_schema.TABLES where table_name NOT IN ('b_mail_message', 'b_search_content_stem');
```
если нужно исключить таблицы `b_mail_message` и `b_search_content_stem`, после чего в другой вкладке терминала зайти на сервер и время от времени проверять размер дампа командой `ls -lh`, чтобы примерно ориентироваться как идёт процесс дампа.
Во время дампа по умолчанию команда `mysqldump` блокирует операции с базой данных, поэтому сайт работать не будет. Конечно можно использовать ключ который отменит блокировку, но тогда во время дампа база будет меняться, и данные будут не консистентны, во время использования сайта с базой из этого дампа будут возникать дополнительные неожиданные ошибки. Если выполняется дамп тестового сервера, то временная недоступность сайта будет не критична.

# Создание виртуальной машины
Виртуальную машину для Битрикс можно создать согласно инструкции из репозитория [https://github.com/abicorios/bitrix_vagrant](https://github.com/abicorios/bitrix_vagrant), но потом не устанавливать сайт через веб-интерфейс, и пропустить оставшуюся часть инструкции.
