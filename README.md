# about_mv_bitrix
Информация о переносе Битрикс. Предполагается что нужно перенести тестовый сайт с сервера на локальную виртуальную машину для разработки. Возможна такая сложность, что если база очень большая то стандартный бэкап Битрикс зависнет. Тогда нужно другим способом переносить.

# Доступ к удалённому серверу
Допустим есть удалённый сервер, который через `ssh` доступен по адресу `abc.def.ghi` (адрес вымышленный), или по ip `192.168.167.166` (вымышленный ip, причём из локального диапазона, на всякий случай), через порт `1234`, от имени пользователя `bitrix`. Тогда удобно в файл `~/.ssh/config` внести строки:
```
Host server
Hostname abc.def.ghi
Port 1234
User bitrix
```
Если доступ известен только по ip, в конфиге вместо `abc.def.ghi` нужно будет напечатать `192.168.167.166`. Если файл `~/.ssh/config` отсутствует, его можно создать.
Это очень удобная настройка, после которой можно логиниться на сервер командой `ssh server` и передавать файлы с сервера на локальный компьютер через удобный синтаксис `rsync -a server:log.txt log.txt`. Если же конфиг не настроен, то нужно будет в командной строке указывать целый ряд параметров, и в случае `rsync` придётся использовать крайне неудобный синтаксис. Поэтому лучше настроить кофиг.

# Дамп базы данных
Возможно в базе есть какие-то слишком большие таблицы, информация из которых не понадобится при разработке. Размер таблиц можно проверить запросом:
```
SELECT
table_schema as `Database`,
table_name AS `Table`,
round(((data_length + index_length) / 1024 / 1024), 2) `Size in MB`
FROM information_schema.TABLES
ORDER BY (data_length + index_length) DESC;
```
Запрос можно выполнить например в административно разделе сайта, в `Настройки->Инструменты->SQL запрос`.

Потом нужно залогиниться на сервер, на котором размещён сайт, `ssh server`. Выполнить дамп структуры базы:
```
mysqldump -u bitrix0 -p --single-transaction --no-data --routines sitemanager > dump.sql
```
При этом будет запрошен пароль. Пароль можно узнать в файле `bitrix/.settings.php`, ближе к завершению файла.

Если ранее выяснилось, например, что таблица `b_mail_message` занимает слишком много места, и её содержимое не важно для разработки, то далее можно выполняя дамп содержимого таблиц исключить `b_mail_message`:
```
mysqldump -u bitrix0 -p sitemanager --no-create-info --skip-triggers --ignore-table=sitemanager.b_mail_message >> dump.sql
```

Если нужно исключить вторую таблицу, например `b_search_content_stem`, то нужно повторить ключ `--ignore-table` ещё раз, то есть получится `mysqldump -u bitrix0 -p sitemanager --no-create-info --skip-triggers --ignore-table=sitemanager.b_mail_message --ignore-table=sitemanager.b_search_content_stem >> medirus.dump.sql`.
Дамп может занять продолжительное время, зависит от размера базы. Не рекомендуется использовать ключи для вывода информации в терминал, это только замедлит процесс. Лучше заранее посмотреть размер базы запросом:
```
SELECT
round(SUM((data_length + index_length) / 1024 / 1024), 2) `Size in MB`
FROM information_schema.TABLES where table_name NOT IN ('b_mail_message', 'b_search_content_stem');
```
если нужно исключить таблицы `b_mail_message` и `b_search_content_stem`, после чего в другой вкладке терминала зайти на сервер и время от времени проверять размер дампа командой `ls -lh`, чтобы примерно ориентироваться как идёт процесс дампа.
Во время дампа по умолчанию команда `mysqldump` блокирует операции с базой данных, поэтому сайт работать не будет. Конечно можно использовать ключ который отменит блокировку, но тогда во время дампа база будет меняться, и данные будут не консистентны, во время использования сайта с базой из этого дампа будут возникать дополнительные неожиданные ошибки. Если выполняется дамп тестового сервера, то временная недоступность сайта будет не критична.

# Создание виртуальной машины
Виртуальную машину для Битрикс можно создать согласно инструкции из репозитория [https://github.com/abicorios/bitrix_vagrant](https://github.com/abicorios/bitrix_vagrant), но потом не устанавливать сайт через веб-интерфейс, и пропустить оставшуюся часть инструкции.

# Сохранение пароля базы данных в виртуальной машины
При создании виртуальной машины автоматически создана база данных для Битрикс, а также пользователь с паролем. Информацию о доступе к базе лучше сохранить таким способом:
```
cd c7
vagrant ssh
sudo -i
cd /home/bitrix
rsync -az www/ www.bac2/
exit
exit
```

# Передача базы данных с сервера на локальный компьютер
Находясь в папке `c7` можно в эту же папку загружать дамп базы командой:
```
rsync -az --info=progress2 server:dump.sql dump.sql
```
Ключ `--info=progress2` выводит удобный прогресс-бар. Можно без него, будет даже быстрее. Тогда просто размер локального дампа можно проверить чтобы сориентироваться на какой стадии процесс.

